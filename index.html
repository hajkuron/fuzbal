<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nedeljska Liga Pro</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase Configuration (loaded from external file) -->
    <script src="config.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script>
        // Initialize Firebase with error handling
        try {
            if (typeof firebase !== 'undefined' && typeof firebaseConfig !== 'undefined') {
                const app = firebase.initializeApp(firebaseConfig);
                const database = firebase.database();
                
                // Make Firebase functions available globally
                window.firebaseDb = database;
                window.firebaseConfig = firebaseConfig;
            } else {
                console.error('Firebase SDK or config not loaded. Make sure config.js exists with your Firebase credentials.');
            }
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }
    </script>

    <!-- Google Fonts: Oswald for "Sports" headers, Inter for UI -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Oswald:wght@500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #09090b; /* Zinc 950 */
            color: #f8fafc;
        }
        
        h1, h2, h3, .font-sport {
            font-family: 'Oswald', sans-serif;
            letter-spacing: 0.5px;
        }

        /* Minimalist Card */
        .min-card {
            background-color: #18181b; /* Zinc 900 */
            border: 1px solid #27272a; /* Zinc 800 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .min-header {
            background-color: rgba(9, 9, 11, 0.9);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #27272a;
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Scrollbar */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #18181b;
            border-radius: 3px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 3px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #52525b;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONS ---
        const Trophy = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>;
        const Calendar = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
        const Shield = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg>;
        const Plus = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
        const X = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
        const TrendingUp = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>;
        const Users = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const Download = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
        const Upload = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;
        const Database = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>;
        const Trash = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
        const Edit = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;

        // --- DATA STORAGE ---
        const STORAGE_KEYS = {
            PLAYERS: 'fuzbal_players',
            MATCHES: 'fuzbal_matches'
        };

        // Check if Firebase is configured
        const isFirebaseConfigured = () => {
            return window.firebaseDb && 
                   window.firebaseConfig && 
                   window.firebaseConfig.apiKey !== "YOUR_API_KEY" &&
                   window.firebaseConfig.databaseURL &&
                   !window.firebaseConfig.databaseURL.includes("YOUR_PROJECT_ID");
        };

        // Realtime Database operations
        const getRealtimeData = async (path) => {
            if (!isFirebaseConfigured()) return null;
            
            try {
                const snapshot = await window.firebaseDb.ref(path).once('value');
                return snapshot.exists() ? snapshot.val() : null;
            } catch (error) {
                console.error('Realtime Database read error:', error);
                return null;
            }
        };

        const saveRealtimeData = async (path, items) => {
            if (!isFirebaseConfigured()) return false;
            
            try {
                await window.firebaseDb.ref(path).set({
                    items,
                    updatedAt: new Date().toISOString()
                });
                return true;
            } catch (error) {
                console.error('Realtime Database write error:', error);
                return false;
            }
        };

        const setupRealtimeListener = (path, callback) => {
            if (!isFirebaseConfigured()) return null;
            
            try {
                const ref = window.firebaseDb.ref(path);
                ref.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        callback(data.items || []);
                    } else {
                        // Handle empty state - send empty array
                        callback([]);
                    }
                });
                // Return unsubscribe function
                return () => ref.off('value');
            } catch (error) {
                console.error('Realtime Database listener error:', error);
                return null;
            }
        };

        // Convert image file to Base64 (stores directly in database)
        const convertImageToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                // Limit file size to 1MB for Base64 (to keep database reasonable)
                if (file.size > 1024 * 1024) {
                    reject(new Error('Slika mora biti manjša od 1MB za shranjevanje v bazi podatkov. Prosimo uporabite manjšo sliko ali URL.'));
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        // Fallback to localStorage
        const getStoredPlayers = () => {
            const stored = localStorage.getItem(STORAGE_KEYS.PLAYERS);
            if (stored) return JSON.parse(stored);
            // Start with empty array - users add their own players
            return [];
        };

        const getStoredMatches = () => {
            const stored = localStorage.getItem(STORAGE_KEYS.MATCHES);
            return stored ? JSON.parse(stored) : [];
        };

        const savePlayers = async (players) => {
            // Try Realtime Database first
            const saved = await saveRealtimeData('players', players);
            if (!saved) {
                // Fallback to localStorage
                localStorage.setItem(STORAGE_KEYS.PLAYERS, JSON.stringify(players));
            }
        };

        const saveMatches = async (matches) => {
            // Try Realtime Database first
            const saved = await saveRealtimeData('matches', matches);
            if (!saved) {
                // Fallback to localStorage
                localStorage.setItem(STORAGE_KEYS.MATCHES, JSON.stringify(matches));
            }
        };

        // Export all data to JSON file
        const exportData = async () => {
            let players, matches;
            
            // Try to get from Realtime Database first
            if (isFirebaseConfigured()) {
                const dbPlayersData = await getRealtimeData('players');
                const dbMatchesData = await getRealtimeData('matches');
                players = dbPlayersData?.items || getStoredPlayers();
                matches = dbMatchesData?.items || getStoredMatches();
            } else {
                players = getStoredPlayers();
                matches = getStoredMatches();
            }
            
            const data = {
                players,
                matches,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fuzbal-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // Import data from JSON file
        const importData = async (file, onSuccess, onError) => {
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data.players || !Array.isArray(data.players)) {
                        throw new Error('Invalid data format: missing players array');
                    }
                    if (!data.matches || !Array.isArray(data.matches)) {
                        throw new Error('Invalid data format: missing matches array');
                    }
                    
                    // Save imported data (will use Firestore if configured)
                    await savePlayers(data.players);
                    await saveMatches(data.matches);
                    
                    onSuccess(data);
                } catch (error) {
                    onError(error.message || 'Failed to import data');
                }
            };
            
            reader.onerror = () => {
                onError('Failed to read file');
            };
            
            reader.readAsText(file);
        };

        // Calculate player stats from match history
        const calculatePlayerStats = (playerId, matches) => {
            let wins = 0;
            let losses = 0;
            const form = [];

            matches.forEach(match => {
                // Only count tracked players (not guest players)
                const winnerIds = match.winnerIds || [];
                const loserIds = match.loserIds || [];
                
                const isWinner = winnerIds.includes(playerId);
                const isLoser = loserIds.includes(playerId);
                
                if (isWinner) {
                    wins++;
                    form.unshift('W');
                } else if (isLoser) {
                    losses++;
                    form.unshift('L');
                }
            });

            // Keep only last 5 results
            return {
                wins,
                losses,
                form: form.slice(0, 5)
            };
        };

        // --- HELPER COMPONENTS ---

        const StatCard = ({ title, value, subtext, icon: Icon, accentColor, iconColor }) => (
            <div className="min-card p-5 rounded-2xl relative overflow-hidden group hover:border-gray-700 transition-colors duration-300">
                <div className="relative z-10 flex justify-between items-start">
                    <div>
                        <p className="text-gray-500 text-[11px] font-bold uppercase tracking-widest mb-1">{title}</p>
                        <p className="text-4xl font-sport font-bold text-white tracking-tight">{value}</p>
                        {subtext && <p className={`text-xs mt-1 font-medium ${iconColor}`}>{subtext}</p>}
                    </div>
                    <div className={`p-2.5 rounded-xl bg-gray-800/50 ${iconColor}`}>
                        <Icon size={20} />
                    </div>
                </div>
            </div>
        );

        const WinRateBar = ({ wins, losses }) => {
            const total = wins + losses;
            const percentage = total === 0 ? 0 : Math.round((wins / total) * 100);
            
            // Clean gradient colors
            let gradient = "from-rose-500 to-rose-600";
            if (percentage >= 40) gradient = "from-amber-400 to-amber-500";
            if (percentage >= 60) gradient = "from-emerald-400 to-emerald-600";

            return (
                <div className="w-full max-w-[120px]">
                    <div className="flex justify-between items-end mb-1.5">
                        <span className="text-[10px] text-gray-500 uppercase font-bold tracking-wider">% Zmag</span>
                        <span className={`font-sport font-bold text-sm ${percentage >= 50 ? 'text-emerald-400' : 'text-gray-400'}`}>{percentage}%</span>
                    </div>
                    <div className="h-2 w-full bg-gray-800 rounded-full overflow-hidden">
                        <div 
                            className={`h-full rounded-full bg-gradient-to-r ${gradient}`} 
                            style={{ width: `${percentage}%` }}
                        />
                    </div>
                </div>
            );
        };

        const FormDots = ({ history }) => (
            <div className="flex gap-1.5">
                {history.map((result, i) => (
                    <div 
                        key={i} 
                        className={`w-2 h-2 rounded-full transition-all ${
                            result === 'W' 
                            ? 'bg-emerald-500' 
                            : result === 'L'
                            ? 'bg-red-500'
                            : 'bg-gray-700'
                        }`}
                        title={result === 'W' ? 'Zmaga' : result === 'L' ? 'Poraz' : 'Ni igral'}
                    />
                ))}
            </div>
        );

        const Avatar = ({ name, rank, imageUrl }) => {
            const [imageError, setImageError] = useState(false);
            const initials = name.split(' ').map(n => n[0]).join('').slice(0,2);
            // Minimalist gradients
            const bgClass = rank === 1 ? 'bg-amber-500 text-amber-950' : 'bg-gray-800 text-gray-400';
            
            // Reset error state when imageUrl changes
            useEffect(() => {
                setImageError(false);
            }, [imageUrl]);
            
            return (
                <div className="relative">
                    {imageUrl && !imageError ? (
                        <div className="w-10 h-10 rounded-full overflow-hidden ring-2 ring-[#18181b] bg-gray-800">
                            <img 
                                src={imageUrl} 
                                alt={name}
                                className="w-full h-full object-cover"
                                onError={() => setImageError(true)}
                            />
                        </div>
                    ) : (
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xs font-bold ${bgClass} ring-2 ring-[#18181b]`}>
                        {initials}
                    </div>
                    )}
                    {rank <= 3 && (
                        <div className={`absolute -top-1 -right-1 w-4 h-4 rounded-full flex items-center justify-center text-[10px] border-2 border-[#18181b] ${
                            rank === 1 ? 'bg-amber-400 text-amber-950' : 
                            rank === 2 ? 'bg-gray-300 text-gray-900' : 
                            'bg-amber-800 text-amber-100'
                        }`}>
                            {rank}
                        </div>
                    )}
                </div>
            );
        };

        const MatchModal = ({ isOpen, onClose, players, onSaveMatch }) => {
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [selectedWinners, setSelectedWinners] = useState([]);
            const [selectedLosers, setSelectedLosers] = useState([]);
            const [guestWinners, setGuestWinners] = useState(['']);
            const [guestLosers, setGuestLosers] = useState(['']);

            useEffect(() => {
                if (!isOpen) {
                    setDate(new Date().toISOString().split('T')[0]);
                    setSelectedWinners([]);
                    setSelectedLosers([]);
                    setGuestWinners(['']);
                    setGuestLosers(['']);
                }
            }, [isOpen]);

            const togglePlayer = (playerId, targetCategory = null) => {
                // If targetCategory is specified (clicked from specific section), use it
                if (targetCategory === 'winners') {
                    // Moving to winners
                    if (selectedWinners.includes(playerId)) {
                        // Already in winners, remove
                        setSelectedWinners(selectedWinners.filter(id => id !== playerId));
                    } else {
                        // Remove from losers if present, add to winners
                        setSelectedLosers(selectedLosers.filter(id => id !== playerId));
                        if (selectedWinners.length < 5) {
                            setSelectedWinners([...selectedWinners, playerId]);
                        }
                    }
                } else if (targetCategory === 'losers') {
                    // Moving to losers
                    if (selectedLosers.includes(playerId)) {
                        // Already in losers, remove
                        setSelectedLosers(selectedLosers.filter(id => id !== playerId));
                    } else {
                        // Remove from winners if present, add to losers
                        setSelectedWinners(selectedWinners.filter(id => id !== playerId));
                        setSelectedLosers([...selectedLosers, playerId]);
                    }
                } else {
                    // Default toggle behavior: cycle through unselected -> winner -> loser -> unselected
                    if (selectedWinners.includes(playerId)) {
                        // Currently winner, move to loser
                        setSelectedWinners(selectedWinners.filter(id => id !== playerId));
                        setSelectedLosers([...selectedLosers, playerId]);
                    } else if (selectedLosers.includes(playerId)) {
                        // Currently loser, remove (unselect)
                        setSelectedLosers(selectedLosers.filter(id => id !== playerId));
                    } else {
                        // Not selected, add to winners if space available
                        if (selectedWinners.length < 5) {
                            setSelectedWinners([...selectedWinners, playerId]);
                        } else {
                            // No space in winners, add to losers
                            setSelectedLosers([...selectedLosers, playerId]);
                        }
                    }
                }
            };

            const updateGuestWinners = (index, value) => {
                const newGuests = [...guestWinners];
                newGuests[index] = value;
                // Add empty field if last one is filled
                if (value && index === newGuests.length - 1) {
                    newGuests.push('');
                }
                // Remove empty fields except the last one
                const filtered = newGuests.filter((g, i) => g.trim() || i === newGuests.length - 1);
                setGuestWinners(filtered.length > 0 ? filtered : ['']);
            };

            const updateGuestLosers = (index, value) => {
                const newGuests = [...guestLosers];
                newGuests[index] = value;
                // Add empty field if last one is filled
                if (value && index === newGuests.length - 1) {
                    newGuests.push('');
                }
                // Remove empty fields except the last one
                const filtered = newGuests.filter((g, i) => g.trim() || i === newGuests.length - 1);
                setGuestLosers(filtered.length > 0 ? filtered : ['']);
            };

            const handleSave = () => {
                if (selectedWinners.length === 0 && guestWinners.filter(g => g.trim()).length === 0) {
                    alert('Izberi vsaj enega zmagovalca!');
                    return;
                }

                const match = {
                    id: Date.now(),
                    date: date,
                    winnerIds: selectedWinners,
                    loserIds: selectedLosers,
                    guestWinners: guestWinners.filter(g => g.trim()),
                    guestLosers: guestLosers.filter(g => g.trim())
                };

                onSaveMatch(match);
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/80 backdrop-blur-sm z-40" onClick={onClose}></div>
                    <div className="min-card w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative z-50 animate-fade-in max-h-[90vh] flex flex-col">
                        <div className="p-5 border-b border-gray-800 flex justify-between items-center bg-gray-900/50 flex-shrink-0 sticky top-0 z-10">
                            <h3 className="text-lg font-sport font-bold text-white uppercase tracking-wide">Vnesi Rezultat Tekme</h3>
                            <button onClick={onClose} className="p-1 hover:bg-gray-800 rounded-full text-gray-400 hover:text-white transition">
                                <X className="w-5 h-5" />
                            </button>
                        </div>
                        <div className="p-6 space-y-6 overflow-y-auto flex-1">
                            {/* Date */}
                            <div>
                                <label className="block text-[11px] font-bold text-gray-500 uppercase tracking-wider mb-2">Datum Tekme</label>
                                <input 
                                    type="date" 
                                    value={date}
                                    onChange={(e) => setDate(e.target.value)}
                                    className="w-full bg-black/50 border border-gray-800 rounded-xl p-3 text-white focus:border-emerald-500 outline-none transition-all" 
                                />
                            </div>

                            {/* Winners */}
                            <div>
                                <label className="block text-[11px] font-bold text-gray-500 uppercase tracking-wider mb-2">
                                    Zmagovalci ({selectedWinners.length + guestWinners.filter(g => g.trim()).length})
                                </label>
                                <div className="space-y-3">
                                    <div className="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto pr-1">
                                        {players.map(player => {
                                            const isWinner = selectedWinners.includes(player.id);
                                            const isLoser = selectedLosers.includes(player.id);
                                            return (
                                                <button 
                                                    key={player.id}
                                                    onClick={() => togglePlayer(player.id, 'winners')}
                                                    className={`py-2.5 rounded-xl text-sm font-medium transition-all ${
                                                        isWinner
                                                            ? 'bg-emerald-500/20 border border-emerald-500/50 text-emerald-400'
                                                            : isLoser
                                                            ? 'bg-gray-700/30 border border-gray-700/30 text-gray-600 opacity-50 cursor-not-allowed'
                                                            : 'bg-gray-800/50 border border-transparent text-gray-400 hover:bg-gray-800'
                                                    }`}
                                                    disabled={isLoser}
                                                    title={isLoser ? 'Igralec je že izbran kot poraženec' : isWinner ? 'Klikni za odstranitev iz zmagovalcev' : 'Klikni za dodajanje med zmagovalce'}
                                                >
                                                    {player.name}
                                                </button>
                                            );
                                        })}
                                    </div>
                                    <div>
                                        <p className="text-[10px] text-gray-600 uppercase tracking-wider mb-2">Gostujoči igralci (brez statistike)</p>
                                        {guestWinners.map((guest, index) => (
                                            <input
                                                key={index}
                                                type="text"
                                                value={guest}
                                                onChange={(e) => updateGuestWinners(index, e.target.value)}
                                                placeholder="Ime gostujočega igralca..."
                                                className="w-full bg-black/50 border border-gray-800 rounded-lg p-2 text-sm text-white mb-2 focus:border-emerald-500 outline-none transition-all"
                                            />
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Losers */}
                            <div>
                                <label className="block text-[11px] font-bold text-gray-500 uppercase tracking-wider mb-2">
                                    Poraženci ({selectedLosers.length + guestLosers.filter(g => g.trim()).length})
                                </label>
                                <div className="space-y-3">
                                    <div className="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto pr-1">
                                        {players.map(player => {
                                            const isWinner = selectedWinners.includes(player.id);
                                            const isLoser = selectedLosers.includes(player.id);
                                            return (
                                                <button 
                                                    key={player.id}
                                                    onClick={() => togglePlayer(player.id, 'losers')}
                                                    className={`py-2.5 rounded-xl text-sm font-medium transition-all ${
                                                        isLoser
                                                            ? 'bg-red-500/20 border border-red-500/50 text-red-400'
                                                            : isWinner
                                                            ? 'bg-emerald-500/20 border border-emerald-500/20 text-emerald-400/50 opacity-50 cursor-not-allowed'
                                                            : 'bg-gray-800/50 border border-transparent text-gray-400 hover:bg-gray-800'
                                                    }`}
                                                    disabled={isWinner}
                                                    title={isWinner ? 'Igralec je že izbran kot zmagovalec' : isLoser ? 'Klikni za odstranitev iz poražencev' : 'Klikni za dodajanje med poražence'}
                                                >
                                                    {player.name}
                                                </button>
                                            );
                                        })}
                                    </div>
                                    <div>
                                        <p className="text-[10px] text-gray-600 uppercase tracking-wider mb-2">Gostujoči igralci (brez statistike)</p>
                                        {guestLosers.map((guest, index) => (
                                            <input
                                                key={index}
                                                type="text"
                                                value={guest}
                                                onChange={(e) => updateGuestLosers(index, e.target.value)}
                                                placeholder="Ime gostujočega igralca..."
                                                className="w-full bg-black/50 border border-gray-800 rounded-lg p-2 text-sm text-white mb-2 focus:border-emerald-500 outline-none transition-all"
                                            />
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <button 
                                onClick={handleSave}
                                disabled={selectedWinners.length === 0 && guestWinners.filter(g => g.trim()).length === 0}
                                className="w-full bg-emerald-500 hover:bg-emerald-400 disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed text-black font-sport font-bold text-lg py-3.5 rounded-xl transition-all shadow-lg shadow-emerald-900/20 active:scale-[0.98]"
                            >
                                Shrani Rezultat
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AddPlayerModal = ({ isOpen, onClose, onAddPlayer }) => {
            const [name, setName] = useState('');
            const [imageUrl, setImageUrl] = useState('');
            const [imageFile, setImageFile] = useState(null);
            const [uploading, setUploading] = useState(false);
            const fileInputRef = React.useRef(null);

            useEffect(() => {
                if (!isOpen) {
                    setName('');
                    setImageUrl('');
                    setImageFile(null);
                    setUploading(false);
                    if (fileInputRef.current) fileInputRef.current.value = '';
                }
            }, [isOpen]);

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) { // 5MB limit
                        alert('Slike mora biti manjša od 5MB');
                        return;
                    }
                    if (!file.type.startsWith('image/')) {
                        alert('Prosimo izberite slikovno datoteko');
                        return;
                    }
                    setImageFile(file);
                    setImageUrl(''); // Clear URL if file is selected
                    // Create preview
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Preview handled by object URL
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleSave = async () => {
                if (!name.trim()) return;
                
                setUploading(true);
                let finalImageUrl = imageUrl.trim() || null;
                
                // Convert file to Base64 if selected
                if (imageFile) {
                    try {
                        finalImageUrl = await convertImageToBase64(imageFile);
                    } catch (error) {
                        console.error('Image conversion failed:', error);
                        alert(error.message || 'Pretvorba slike ni uspela. Poskusite znova ali uporabite URL.');
                        setUploading(false);
                        return;
                    }
                }
                
                onAddPlayer(name.trim(), finalImageUrl);
                setUploading(false);
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="min-card w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative animate-fade-in max-h-[90vh] overflow-y-auto">
                        <div className="p-5 border-b border-gray-800 flex justify-between items-center bg-gray-900/50">
                            <h3 className="text-lg font-sport font-bold text-white uppercase tracking-wide">Dodaj Igralca</h3>
                            <button onClick={onClose} className="p-1 hover:bg-gray-800 rounded-full text-gray-400 hover:text-white transition">
                                <X className="w-5 h-5" />
                            </button>
                        </div>
                        <div className="p-6 space-y-6">
                            <div>
                                <label className="block text-[11px] font-bold text-gray-500 uppercase tracking-wider mb-2">Ime Igralca *</label>
                                <input 
                                    type="text" 
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSave()}
                                    placeholder="Vnesi ime..."
                                    className="w-full bg-black/50 border border-gray-800 rounded-xl p-3 text-white focus:border-emerald-500 outline-none transition-all" 
                                />
                            </div>
                            <div>
                                <label className="block text-[11px] font-bold text-gray-500 uppercase tracking-wider mb-2">Slika Profila (opcijsko)</label>
                                
                                {/* File Upload Option */}
                                <div className="mb-3">
                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        accept="image/*"
                                        onChange={handleFileSelect}
                                        className="hidden"
                                        id="player-image-upload"
                                    />
                                    <label
                                        htmlFor="player-image-upload"
                                        className="w-full bg-gray-800/50 border border-gray-800 rounded-xl p-3 text-white cursor-pointer hover:bg-gray-800 transition-all flex items-center justify-center gap-2 text-sm"
                                    >
                                        <Upload className="w-4 h-4" />
                                        <span>{imageFile ? imageFile.name : 'Naloži sliko'}</span>
                                    </label>
                                    {imageFile && (
                                        <button
                                            onClick={() => {
                                                setImageFile(null);
                                                if (fileInputRef.current) fileInputRef.current.value = '';
                                            }}
                                            className="text-xs text-red-400 mt-1 hover:text-red-300"
                                        >
                                            Odstrani
                                        </button>
                                    )}
                                </div>

                                {/* OR Divider */}
                                <div className="flex items-center gap-2 my-3">
                                    <div className="flex-1 h-px bg-gray-800"></div>
                                    <span className="text-xs text-gray-600">ALI</span>
                                    <div className="flex-1 h-px bg-gray-800"></div>
                                </div>

                                {/* URL Option */}
                                <div>
                                    <input 
                                        type="url" 
                                        value={imageUrl}
                                        onChange={(e) => {
                                            setImageUrl(e.target.value);
                                            setImageFile(null); // Clear file if URL is entered
                                            if (fileInputRef.current) fileInputRef.current.value = '';
                                        }}
                                        placeholder="https://example.com/photo.jpg"
                                        className="w-full bg-black/50 border border-gray-800 rounded-xl p-3 text-white focus:border-emerald-500 outline-none transition-all text-sm" 
                                    />
                                    <p className="text-xs text-gray-600 mt-2">
                                        Vnesite URL slike (opcijsko, če niste naložili datoteke)
                                    </p>
                                </div>

                                {/* Preview */}
                                {(imageFile || imageUrl) && (
                                    <div className="mt-3">
                                        <p className="text-xs text-gray-500 mb-2">Predogled:</p>
                                        <div className="w-20 h-20 rounded-full overflow-hidden border-2 border-gray-800 bg-gray-800">
                                            <img 
                                                src={imageFile ? URL.createObjectURL(imageFile) : imageUrl} 
                                                alt="Preview"
                                                className="w-full h-full object-cover"
                                                onError={(e) => {
                                                    e.target.style.display = 'none';
                                                    e.target.parentElement.innerHTML = '<div class="w-full h-full flex items-center justify-center text-gray-600 text-xs">Napaka</div>';
                                                }}
                                            />
                                        </div>
                                    </div>
                                )}
                            </div>
                            <button 
                                onClick={handleSave}
                                disabled={!name.trim() || uploading}
                                className="w-full bg-emerald-500 hover:bg-emerald-400 disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed text-black font-sport font-bold text-lg py-3.5 rounded-xl transition-all shadow-lg shadow-emerald-900/20 active:scale-[0.98] flex items-center justify-center gap-2"
                            >
                                {uploading ? (
                                    <>
                                        <div className="w-5 h-5 border-2 border-black border-t-transparent rounded-full animate-spin"></div>
                                        <span>Nalaganje...</span>
                                    </>
                                ) : (
                                    'Dodaj Igralca'
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const EditPlayerModal = ({ isOpen, onClose, player, onSavePlayer }) => {
            const [name, setName] = useState('');
            const [imageUrl, setImageUrl] = useState('');
            const [imageFile, setImageFile] = useState(null);
            const [uploading, setUploading] = useState(false);
            const fileInputRef = React.useRef(null);

            useEffect(() => {
                if (isOpen && player) {
                    setName(player.name || '');
                    setImageUrl(player.imageUrl || '');
                    setImageFile(null);
                    setUploading(false);
                    if (fileInputRef.current) fileInputRef.current.value = '';
                } else if (!isOpen) {
                    setName('');
                    setImageUrl('');
                    setImageFile(null);
                    setUploading(false);
                    if (fileInputRef.current) fileInputRef.current.value = '';
                }
            }, [isOpen, player]);

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) { // 5MB limit
                        alert('Slike mora biti manjša od 5MB');
                        return;
                    }
                    if (!file.type.startsWith('image/')) {
                        alert('Prosimo izberite slikovno datoteko');
                        return;
                    }
                    setImageFile(file);
                    setImageUrl(''); // Clear URL if file is selected
                }
            };

            const handleSave = async () => {
                if (!name.trim()) return;
                
                setUploading(true);
                let finalImageUrl = imageUrl.trim() || null;
                
                // Convert file to Base64 if selected
                if (imageFile) {
                    try {
                        finalImageUrl = await convertImageToBase64(imageFile);
                    } catch (error) {
                        console.error('Image conversion failed:', error);
                        alert(error.message || 'Pretvorba slike ni uspela. Poskusite znova ali uporabite URL.');
                        setUploading(false);
                        return;
                    }
                }
                
                // If no new image and no existing imageUrl, keep current
                if (!finalImageUrl && !imageFile && player.imageUrl) {
                    finalImageUrl = player.imageUrl;
                }
                
                onSavePlayer(player.id, name.trim(), finalImageUrl);
                setUploading(false);
                onClose();
            };

            if (!isOpen || !player) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="min-card w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative animate-fade-in max-h-[90vh] overflow-y-auto">
                        <div className="p-5 border-b border-gray-800 flex justify-between items-center bg-gray-900/50">
                            <h3 className="text-lg font-sport font-bold text-white uppercase tracking-wide">Uredi Igralca</h3>
                            <button onClick={onClose} className="p-1 hover:bg-gray-800 rounded-full text-gray-400 hover:text-white transition">
                                <X className="w-5 h-5" />
                            </button>
                        </div>
                        <div className="p-6 space-y-6">
                            <div>
                                <label className="block text-[11px] font-bold text-gray-500 uppercase tracking-wider mb-2">Ime Igralca *</label>
                                <input 
                                    type="text" 
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSave()}
                                    placeholder="Vnesi ime..."
                                    className="w-full bg-black/50 border border-gray-800 rounded-xl p-3 text-white focus:border-emerald-500 outline-none transition-all" 
                                />
                            </div>
                            <div>
                                <label className="block text-[11px] font-bold text-gray-500 uppercase tracking-wider mb-2">Slika Profila (opcijsko)</label>
                                
                                {/* Current Image Preview */}
                                {player.imageUrl && !imageFile && !imageUrl && (
                                    <div className="mb-3">
                                        <p className="text-xs text-gray-500 mb-2">Trenutna slika:</p>
                                        <div className="w-20 h-20 rounded-full overflow-hidden border-2 border-gray-800 bg-gray-800">
                                            <img 
                                                src={player.imageUrl} 
                                                alt={player.name}
                                                className="w-full h-full object-cover"
                                            />
                                        </div>
                                    </div>
                                )}
                                
                                {/* File Upload Option */}
                                <div className="mb-3">
                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        accept="image/*"
                                        onChange={handleFileSelect}
                                        className="hidden"
                                        id="edit-player-image-upload"
                                    />
                                    <label
                                        htmlFor="edit-player-image-upload"
                                        className="w-full bg-gray-800/50 border border-gray-800 rounded-xl p-3 text-white cursor-pointer hover:bg-gray-800 transition-all flex items-center justify-center gap-2 text-sm"
                                    >
                                        <Upload className="w-4 h-4" />
                                        <span>{imageFile ? imageFile.name : 'Naloži novo sliko'}</span>
                                    </label>
                                    {imageFile && (
                                        <button
                                            onClick={() => {
                                                setImageFile(null);
                                                if (fileInputRef.current) fileInputRef.current.value = '';
                                            }}
                                            className="text-xs text-red-400 mt-1 hover:text-red-300"
                                        >
                                            Odstrani
                                        </button>
                                    )}
                                </div>

                                {/* OR Divider */}
                                <div className="flex items-center gap-2 my-3">
                                    <div className="flex-1 h-px bg-gray-800"></div>
                                    <span className="text-xs text-gray-600">ALI</span>
                                    <div className="flex-1 h-px bg-gray-800"></div>
                                </div>

                                {/* URL Option */}
                                <div>
                                    <input 
                                        type="url" 
                                        value={imageUrl}
                                        onChange={(e) => {
                                            setImageUrl(e.target.value);
                                            setImageFile(null);
                                            if (fileInputRef.current) fileInputRef.current.value = '';
                                        }}
                                        placeholder="https://example.com/photo.jpg"
                                        className="w-full bg-black/50 border border-gray-800 rounded-xl p-3 text-white focus:border-emerald-500 outline-none transition-all text-sm" 
                                    />
                                    <p className="text-xs text-gray-600 mt-2">
                                        Vnesite URL slike (opcijsko, če niste naložili datoteke)
                                    </p>
                                </div>

                                {/* Preview */}
                                {(imageFile || imageUrl) && (
                                    <div className="mt-3">
                                        <p className="text-xs text-gray-500 mb-2">Nov predogled:</p>
                                        <div className="w-20 h-20 rounded-full overflow-hidden border-2 border-gray-800 bg-gray-800">
                                            <img 
                                                src={imageFile ? URL.createObjectURL(imageFile) : imageUrl} 
                                                alt="Preview"
                                                className="w-full h-full object-cover"
                                                onError={(e) => {
                                                    e.target.style.display = 'none';
                                                    e.target.parentElement.innerHTML = '<div class="w-full h-full flex items-center justify-center text-gray-600 text-xs">Napaka</div>';
                                                }}
                                            />
                                        </div>
                                    </div>
                                )}
                            </div>
                            <button 
                                onClick={handleSave}
                                disabled={!name.trim() || uploading}
                                className="w-full bg-emerald-500 hover:bg-emerald-400 disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed text-black font-sport font-bold text-lg py-3.5 rounded-xl transition-all shadow-lg shadow-emerald-900/20 active:scale-[0.98] flex items-center justify-center gap-2"
                            >
                                {uploading ? (
                                    <>
                                        <div className="w-5 h-5 border-2 border-black border-t-transparent rounded-full animate-spin"></div>
                                        <span>Nalaganje...</span>
                                    </>
                                ) : (
                                    'Shrani Spremembe'
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ImportModal = ({ isOpen, onClose, onImportSuccess, onImportError }) => {
            const [error, setError] = useState('');
            const fileInputRef = React.useRef(null);

            useEffect(() => {
                if (!isOpen) {
                    setError('');
                    if (fileInputRef.current) fileInputRef.current.value = '';
                }
            }, [isOpen]);

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                    setError('Prosimo izberite JSON datoteko');
                    return;
                }

                importData(file, 
                    (data) => {
                        onImportSuccess(data);
                        onClose();
                    },
                    (errorMsg) => {
                        setError(errorMsg);
                    }
                );
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="min-card w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative animate-fade-in">
                        <div className="p-5 border-b border-gray-800 flex justify-between items-center bg-gray-900/50">
                            <h3 className="text-lg font-sport font-bold text-white uppercase tracking-wide">Uvozi Podatke</h3>
                            <button onClick={onClose} className="p-1 hover:bg-gray-800 rounded-full text-gray-400 hover:text-white transition">
                                <X className="w-5 h-5" />
                            </button>
                        </div>
                        <div className="p-6 space-y-6">
                            <div>
                                <p className="text-sm text-gray-400 mb-4">
                                    Uvozi prejšnjo varnostno kopijo podatkov. To bo zamenjalo vse trenutne podatke!
                                </p>
                                <input
                                    ref={fileInputRef}
                                    type="file"
                                    accept=".json,application/json"
                                    onChange={handleFileSelect}
                                    className="hidden"
                                    id="import-file-input"
                                />
                                <label
                                    htmlFor="import-file-input"
                                    className="w-full bg-gray-800/50 border border-gray-800 rounded-xl p-4 text-white cursor-pointer hover:bg-gray-800 transition-all flex items-center justify-center gap-2"
                                >
                                    <Upload className="w-5 h-5" />
                                    <span>Izberi JSON datoteko</span>
                                </label>
                                {error && (
                                    <p className="text-red-400 text-sm mt-2">{error}</p>
                                )}
                            </div>
                            <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-3">
                                <p className="text-xs text-amber-400">
                                    <strong>Opozorilo:</strong> Uvoz bo zamenjal vse trenutne podatke. Pred uvozom naredite varnostno kopijo!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Format date for display
        const formatDate = (dateString) => {
            const date = new Date(dateString);
            const day = date.getDate();
            const month = date.toLocaleDateString('sl-SI', { month: 'short' });
            return `${day}. ${month}`;
        };

        const PlayerProfileModal = ({ isOpen, onClose, player, matches, allPlayers }) => {
            if (!isOpen || !player) return null;

            // Get player's matches (sorted by date, newest first)
            const playerMatches = matches
                .filter(match => {
                    const winnerIds = match.winnerIds || [];
                    const loserIds = match.loserIds || [];
                    return winnerIds.includes(player.id) || loserIds.includes(player.id);
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            // Get match result for player
            const getMatchResult = (match) => {
                const winnerIds = match.winnerIds || [];
                const loserIds = match.loserIds || [];
                if (winnerIds.includes(player.id)) return 'W';
                if (loserIds.includes(player.id)) return 'L';
                return null; // Didn't play
            };

            // Get winner team names
            const getWinnerTeam = (match) => {
                const winnerIds = match.winnerIds || [];
                const winners = allPlayers.filter(p => winnerIds.includes(p.id)).map(p => p.name);
                const guestWinners = match.guestWinners || [];
                return [...winners, ...guestWinners];
            };

            // Get loser team names
            const getLoserTeam = (match) => {
                const loserIds = match.loserIds || [];
                const losers = allPlayers.filter(p => loserIds.includes(p.id)).map(p => p.name);
                const guestLosers = match.guestLosers || [];
                return [...losers, ...guestLosers];
            };

            const stats = calculatePlayerStats(player.id, matches);
            const totalMatches = stats.wins + stats.losses;
            const winRate = totalMatches > 0 ? Math.round((stats.wins / totalMatches) * 100) : 0;

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="min-card w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative animate-fade-in max-h-[90vh] flex flex-col">
                        <div className="p-5 border-b border-gray-800 flex justify-between items-center bg-gray-900/50">
                            <h3 className="text-lg font-sport font-bold text-white uppercase tracking-wide">Profil Igralca</h3>
                            <button onClick={onClose} className="p-1 hover:bg-gray-800 rounded-full text-gray-400 hover:text-white transition">
                                <X className="w-5 h-5" />
                            </button>
                        </div>
                        <div className="p-6 space-y-6 overflow-y-auto">
                            {/* Player Header */}
                            <div className="flex flex-col items-center text-center">
                                <div className="w-24 h-24 rounded-full overflow-hidden border-4 border-emerald-500/30 bg-gray-800 mb-4">
                                    {player.imageUrl ? (
                                        <img 
                                            src={player.imageUrl} 
                                            alt={player.name}
                                            className="w-full h-full object-cover"
                                        />
                                    ) : (
                                        <div className="w-full h-full flex items-center justify-center text-2xl font-bold text-gray-400">
                                            {player.name.split(' ').map(n => n[0]).join('').slice(0,2)}
                                        </div>
                                    )}
                                </div>
                                <h2 className="text-2xl font-sport font-bold text-white mb-2">{player.name}</h2>
                                <div className="flex items-center gap-4 text-sm">
                                    <div className="text-center">
                                        <div className="text-emerald-400 font-bold text-lg">{stats.wins}</div>
                                        <div className="text-gray-500 text-xs">Zmage</div>
                                    </div>
                                    <div className="w-px h-8 bg-gray-800"></div>
                                    <div className="text-center">
                                        <div className="text-red-400 font-bold text-lg">{stats.losses}</div>
                                        <div className="text-gray-500 text-xs">Porazi</div>
                                    </div>
                                    <div className="w-px h-8 bg-gray-800"></div>
                                    <div className="text-center">
                                        <div className="text-white font-bold text-lg">{winRate}%</div>
                                        <div className="text-gray-500 text-xs">% Zmag</div>
                                    </div>
                                </div>
                            </div>

                            {/* Match History */}
                            <div>
                                <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">
                                    Zgodovina Tekem ({playerMatches.length})
                                </h3>
                                {playerMatches.length === 0 ? (
                                    <div className="text-center py-8 text-gray-500 text-sm">
                                        Igralec še ni igral nobene tekme.
                                    </div>
                                ) : (
                                    <div className="max-h-[400px] overflow-y-auto space-y-2 pr-2 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-gray-900">
                                        {playerMatches.map((match) => {
                                            const result = getMatchResult(match);
                                            const winnerTeam = getWinnerTeam(match);
                                            const loserTeam = getLoserTeam(match);
                                            const isWinner = result === 'W';
                                            
                                            return (
                                                <div 
                                                    key={match.id}
                                                    className={`p-3 rounded-xl border transition-colors ${
                                                        isWinner 
                                                            ? 'bg-emerald-500/10 border-emerald-500/30 hover:border-emerald-500/50' 
                                                            : result === 'L'
                                                            ? 'bg-red-500/10 border-red-500/30 hover:border-red-500/50'
                                                            : 'bg-[#27272a]/50 border-[#27272a] hover:border-gray-700'
                                                    }`}
                                                >
                                                    <div className="flex items-center justify-between mb-3">
                                                        <span className="text-xs text-gray-500 font-bold uppercase">
                                                            {formatDate(match.date)}
                                                        </span>
                                                        <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${
                                                            result === 'W' ? 'bg-emerald-500/20 text-emerald-400' :
                                                            result === 'L' ? 'bg-red-500/20 text-red-400' :
                                                            'bg-gray-800 text-gray-600'
                                                        }`}>
                                                            {result || '-'}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Winner Team */}
                                                    <div className="mb-2">
                                                        <div className="text-xs text-gray-500 mb-1 font-semibold uppercase">Zmagovalci</div>
                                                        <div className="flex flex-wrap gap-1.5">
                                                            {winnerTeam.map((name, idx) => (
                                                                <span 
                                                                    key={idx}
                                                                    className={`px-2 py-1 rounded-md text-xs font-medium ${
                                                                        name === player.name
                                                                            ? 'bg-emerald-500/30 text-emerald-300 border border-emerald-500/50'
                                                                            : 'bg-emerald-500/20 text-emerald-400'
                                                                    }`}
                                                                >
                                                                    {name}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Loser Team */}
                                                    <div>
                                                        <div className="text-xs text-gray-500 mb-1 font-semibold uppercase">Porazenci</div>
                                                        <div className="flex flex-wrap gap-1.5">
                                                            {loserTeam.map((name, idx) => (
                                                                <span 
                                                                    key={idx}
                                                                    className={`px-2 py-1 rounded-md text-xs font-medium ${
                                                                        name === player.name
                                                                            ? 'bg-red-500/30 text-red-300 border border-red-500/50'
                                                                            : 'bg-red-500/20 text-red-400'
                                                                    }`}
                                                                >
                                                                    {name}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>

                            {/* Form History (Last 10 matches) */}
                            <div>
                                <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">
                                    Forma (Zadnjih 10 tekem)
                                </h3>
                                <div className="flex gap-2 flex-wrap">
                                    {playerMatches.length > 0 ? (
                                        playerMatches.slice(0, 10).map((match, index) => {
                                            const result = getMatchResult(match);
                                            return (
                                                <div
                                                    key={match.id}
                                                    className={`w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold ${
                                                        result === 'W' ? 'bg-emerald-500 text-emerald-950' :
                                                        result === 'L' ? 'bg-red-500 text-red-950' :
                                                        'bg-gray-800 text-gray-600'
                                                    }`}
                                                    title={`${formatDate(match.date)}: ${result === 'W' ? 'Zmaga' : result === 'L' ? 'Poraz' : 'Ni igral'}`}
                                                >
                                                    {result || '-'}
                                                </div>
                                            );
                                        })
                                    ) : (
                                        <div className="text-gray-600 text-sm">Ni podatkov</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---

        function App() {
            const [activeTab, setActiveTab] = useState('standings');
            const [showMatchModal, setShowMatchModal] = useState(false);
            const [showPlayerModal, setShowPlayerModal] = useState(false);
            const [showEditPlayerModal, setShowEditPlayerModal] = useState(false);
            const [editingPlayer, setEditingPlayer] = useState(null);
            const [showPlayerProfileModal, setShowPlayerProfileModal] = useState(false);
            const [selectedPlayerProfile, setSelectedPlayerProfile] = useState(null);
            const [showImportModal, setShowImportModal] = useState(false);
            const [players, setPlayers] = useState([]);
            const [matches, setMatches] = useState([]);
            const [mounted, setMounted] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);

            // Load data on mount - Realtime Database or localStorage
            useEffect(() => {
                const loadData = async () => {
                    try {
                        if (isFirebaseConfigured()) {
                            // Try Realtime Database first
                            setIsSyncing(true);
                            const dbPlayersData = await getRealtimeData('players');
                            const dbMatchesData = await getRealtimeData('matches');
                            
                            const dbPlayers = dbPlayersData?.items || null;
                            const dbMatches = dbMatchesData?.items || null;
                            
                            if (dbPlayers !== null && dbPlayers.length > 0) {
                                setPlayers(dbPlayers);
                            } else {
                                setPlayers(getStoredPlayers());
                            }
                            
                            if (dbMatches !== null) {
                                setMatches(dbMatches);
                            } else {
                                setMatches(getStoredMatches());
                            }
                            
                            setIsSyncing(false);
                            
                            // Set up real-time listeners
                            const unsubscribePlayers = setupRealtimeListener('players', (data) => {
                                // Handle both empty and non-empty arrays
                                if (data !== null && Array.isArray(data)) {
                                    setPlayers(data);
                                }
                            });
                            
                            const unsubscribeMatches = setupRealtimeListener('matches', (data) => {
                                // Handle both empty and non-empty arrays
                                if (data !== null && Array.isArray(data)) {
                                    setMatches(data);
                                }
                            });
                            
                            // Cleanup listeners on unmount
                            return () => {
                                if (unsubscribePlayers) unsubscribePlayers();
                                if (unsubscribeMatches) unsubscribeMatches();
                            };
                        } else {
                            // Fallback to localStorage
                            setPlayers(getStoredPlayers());
                            setMatches(getStoredMatches());
                        }
                    } catch (error) {
                        console.error('Error loading data:', error);
                        // Fallback to localStorage on error
                        setPlayers(getStoredPlayers());
                        setMatches(getStoredMatches());
                    } finally {
                        // Always set mounted to true, even if there's an error
                setMounted(true);
                    }
                };
                
                loadData();
            }, []);

            // Save players when they change (debounced)
            useEffect(() => {
                if (mounted && players.length > 0) {
                    const timeoutId = setTimeout(() => {
                        savePlayers(players);
                    }, 500); // Debounce saves
                    return () => clearTimeout(timeoutId);
                }
            }, [players, mounted]);

            // Save matches when they change (debounced)
            useEffect(() => {
                if (mounted) {
                    const timeoutId = setTimeout(() => {
                        saveMatches(matches);
                    }, 500); // Debounce saves
                    return () => clearTimeout(timeoutId);
                }
            }, [matches, mounted]);

            const addPlayer = (name, imageUrl = null) => {
                const newPlayer = {
                    id: Date.now(),
                    name: name,
                    imageUrl: imageUrl || null
                };
                setPlayers([...players, newPlayer]);
            };

            const editPlayer = (playerId, newName, newImageUrl = null) => {
                setPlayers(players.map(player => 
                    player.id === playerId 
                        ? { ...player, name: newName, imageUrl: newImageUrl !== null ? newImageUrl : player.imageUrl }
                        : player
                ));
            };

            const removePlayer = async (playerId) => {
                if (window.confirm('Ali ste prepričani, da želite izbrisati tega igralca? To bo tudi izbrisalo vse njegove tekme iz zgodovine.')) {
                    // Remove player from state
                    const updatedPlayers = players.filter(p => p.id !== playerId);
                    setPlayers(updatedPlayers);
                    
                    // Remove matches involving this player
                    const updatedMatches = matches.filter(match => {
                        const winnerIds = match.winnerIds || [];
                        const loserIds = match.loserIds || [];
                        return !winnerIds.includes(playerId) && !loserIds.includes(playerId);
                    });
                    setMatches(updatedMatches);
                    
                    // Save immediately to Firebase (don't wait for debounce)
                    await savePlayers(updatedPlayers);
                    await saveMatches(updatedMatches);
                }
            };

            const addMatch = (match) => {
                setMatches([match, ...matches]);
            };

            const removeMatch = async (matchId) => {
                if (window.confirm('Ali ste prepričani, da želite izbrisati to tekmo?')) {
                    const updatedMatches = matches.filter(m => m.id !== matchId);
                    setMatches(updatedMatches);
                    // Save immediately to Firebase
                    await saveMatches(updatedMatches);
                }
            };

            const handleImportSuccess = async (data) => {
                // Reload data (from Realtime Database if configured, otherwise localStorage)
                if (isFirebaseConfigured()) {
                    const dbPlayersData = await getRealtimeData('players');
                    const dbMatchesData = await getRealtimeData('matches');
                    const dbPlayers = dbPlayersData?.items || null;
                    const dbMatches = dbMatchesData?.items || null;
                    setPlayers(dbPlayers || data.players);
                    setMatches(dbMatches || data.matches);
                } else {
                    setPlayers(getStoredPlayers());
                    setMatches(getStoredMatches());
                }
                alert(`Podatki uspešno uvoženi!\nIgralci: ${data.players.length}\nTekme: ${data.matches.length}`);
            };

            const handleImportError = (error) => {
                console.error('Import error:', error);
            };

            // Calculate stats for each player
            const playersWithStats = players.map(player => {
                const stats = calculatePlayerStats(player.id, matches);
                return {
                    ...player,
                    ...stats
                };
            });

            const sortedPlayers = [...playersWithStats].sort((a, b) => {
                const totalA = a.wins + a.losses;
                const totalB = b.wins + b.losses;
                if (totalA === 0 && totalB === 0) return 0;
                if (totalA === 0) return 1;
                if (totalB === 0) return -1;
                
                const rateA = a.wins / totalA;
                const rateB = b.wins / totalB;
                if (rateB !== rateA) return rateB - rateA;
                return b.wins - a.wins;
            });

            // Check if there's a true tie at the top
            const getLeadingPlayer = () => {
                if (sortedPlayers.length === 0) return null;
                
                const topPlayer = sortedPlayers[0];
                const topTotal = topPlayer.wins + topPlayer.losses;
                
                // If no games played, no leader
                if (topTotal === 0) return null;
                
                const topRate = topPlayer.wins / topTotal;
                
                // Check if any other player has the same win rate AND same wins
                const isTied = sortedPlayers.some((player, index) => {
                    if (index === 0) return false; // Skip first player
                    const playerTotal = player.wins + player.losses;
                    if (playerTotal === 0) return false; // Players with no games don't count
                    const playerRate = player.wins / playerTotal;
                    return playerRate === topRate && player.wins === topPlayer.wins;
                });
                
                return isTied ? null : topPlayer;
            };

            const leadingPlayer = getLeadingPlayer();

            // Get longest win streak
            const getLongestWinStreak = () => {
                let maxStreak = 0;
                let playerName = '';
                
                sortedPlayers.forEach(player => {
                    let streak = 0;
                    player.form.forEach(result => {
                        if (result === 'W') {
                            streak++;
                            if (streak > maxStreak) {
                                maxStreak = streak;
                                playerName = player.name;
                            }
                        } else {
                            streak = 0;
                        }
                    });
                });
                
                return { streak: maxStreak, name: playerName };
            };

            const winStreak = getLongestWinStreak();

            if (!mounted) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-[#09090b]">
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-gray-400">Nalaganje...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-24 selection:bg-emerald-500 selection:text-white">
                    
                    {/* Header */}
                    <div className="min-header sticky top-0 z-40 px-4 py-4">
                        <div className="max-w-3xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                {/* Logo Mark */}
                                <div className="w-9 h-9 bg-emerald-500 text-black rounded-xl flex items-center justify-center shadow-lg">
                                    <span className="font-sport font-bold text-lg">F</span>
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold tracking-tight leading-none text-white">FUZBAL</h1>
                                    <div className="flex items-center gap-2 mt-0.5">
                                        <div className={`w-1.5 h-1.5 rounded-full ${isFirebaseConfigured() ? 'bg-emerald-500' : 'bg-gray-500'}`}></div>
                                        <p className="text-[10px] text-gray-500 font-bold uppercase tracking-widest">
                                            1. Sezona
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button 
                                    onClick={() => setActiveTab('players')}
                                    className="p-2 hover:bg-gray-800 rounded-lg text-gray-400 hover:text-white transition"
                                    title="Upravljanje Igralcev"
                                >
                                    <Users className="w-5 h-5" />
                                </button>
                                <button 
                                    onClick={exportData}
                                    className="p-2 hover:bg-gray-800 rounded-lg text-gray-400 hover:text-white transition"
                                    title="Izvozi Podatke (Varnostna Kopija)"
                                >
                                    <Download className="w-5 h-5" />
                                </button>
                                <button 
                                    onClick={() => setShowImportModal(true)}
                                    className="p-2 hover:bg-gray-800 rounded-lg text-gray-400 hover:text-white transition"
                                    title="Uvozi Podatke"
                                >
                                    <Upload className="w-5 h-5" />
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-3xl mx-auto p-4 space-y-8 mt-2">
                        
                        {/* Hero Stats */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 animate-fade-in">
                            <StatCard 
                                title="Vodilni Igralec" 
                                value={leadingPlayer ? leadingPlayer.name : 'Ni vodilnega'} 
                                subtext={leadingPlayer ? "Trenutni Prvak" : sortedPlayers.length > 0 ? "Izenačeno" : ''}
                                icon={Trophy} 
                                iconColor="text-amber-400"
                            />
                            <div className="grid grid-cols-2 gap-4">
                                <StatCard 
                                    title="Tekme" 
                                    value={matches.length} 
                                    icon={Calendar} 
                                    iconColor="text-blue-400"
                                />
                                <StatCard 
                                    title="Niz Zmag" 
                                    value={winStreak.streak > 0 ? `${winStreak.streak}Z` : '0Z'} 
                                    subtext={winStreak.name || ''}
                                    icon={TrendingUp} 
                                    iconColor="text-emerald-400"
                                />
                            </div>
                        </div>

                        {/* Navigation Tabs */}
                        <div className="flex items-center gap-2 bg-[#18181b] p-1.5 rounded-xl border border-[#27272a]">
                            <button 
                                onClick={() => setActiveTab('standings')}
                                className={`flex-1 py-2.5 text-xs font-bold uppercase tracking-wider rounded-lg transition-all ${activeTab === 'standings' ? 'bg-[#27272a] text-white shadow-sm' : 'text-gray-500 hover:text-gray-300 hover:bg-[#27272a]/50'}`}
                            >
                                Lestvica
                            </button>
                            <button 
                                onClick={() => setActiveTab('history')}
                                className={`flex-1 py-2.5 text-xs font-bold uppercase tracking-wider rounded-lg transition-all ${activeTab === 'history' ? 'bg-[#27272a] text-white shadow-sm' : 'text-gray-500 hover:text-gray-300 hover:bg-[#27272a]/50'}`}
                            >
                                Zgodovina
                            </button>
                            <button 
                                onClick={() => setActiveTab('players')}
                                className={`flex-1 py-2.5 text-xs font-bold uppercase tracking-wider rounded-lg transition-all ${activeTab === 'players' ? 'bg-[#27272a] text-white shadow-sm' : 'text-gray-500 hover:text-gray-300 hover:bg-[#27272a]/50'}`}
                            >
                                Igralci
                            </button>
                        </div>

                        {/* VIEW: Leaderboard */}
                        {activeTab === 'standings' && (
                            <div className="min-card rounded-2xl overflow-hidden animate-fade-in">
                                {sortedPlayers.length === 0 ? (
                                    <div className="p-8 text-center text-gray-500">
                                        <p className="text-sm">Ni igralcev. Dodaj prvega igralca!</p>
                                    </div>
                                ) : (
                                <div className="divide-y divide-[#27272a]">
                                    {sortedPlayers.map((player, index) => (
                                        <div 
                                            key={player.id} 
                                            onClick={() => {
                                                setSelectedPlayerProfile(player);
                                                setShowPlayerProfileModal(true);
                                            }}
                                            className="p-4 flex items-center justify-between hover:bg-[#27272a]/40 transition-colors group cursor-pointer"
                                        >
                                            
                                            {/* Left: Rank & Info */}
                                            <div className="flex items-center gap-4">
                                                <div className={`font-sport font-bold text-xl w-6 text-center tabular-nums 
                                                    ${index === 0 ? 'text-amber-500' : 
                                                      index === 1 ? 'text-gray-300' : 
                                                      index === 2 ? 'text-amber-800' : 'text-gray-600'}`}>
                                                    {index + 1}
                                                </div>
                                                
                                                <Avatar name={player.name} rank={index + 1} imageUrl={player.imageUrl} />
                                                
                                                <div>
                                                    <div className="font-bold text-gray-200 text-sm">{player.name}</div>
                                                    <div className="flex md:hidden mt-1 opacity-70">
                                                        <FormDots history={player.form} />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Right: Stats */}
                                            <div className="flex items-center justify-end gap-6 sm:gap-8">
                                                <div className="text-right hidden sm:block">
                                                    <div className="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-0.5">Razmerje</div>
                                                    <div className="font-sport text-lg">
                                                        {player.wins + player.losses > 0 ? (
                                                            <>
                                                                <span className="font-bold text-emerald-400">{player.wins}</span>
                                                        <span className="text-gray-600 mx-1">-</span>
                                                                <span className="font-bold text-red-400">{player.losses}</span>
                                                            </>
                                                        ) : (
                                                            <span className="text-gray-600 text-sm">Ni tekem</span>
                                                        )}
                                                    </div>
                                                </div>

                                                <div className="flex flex-col items-end min-w-[100px]">
                                                    <WinRateBar wins={player.wins} losses={player.losses} />
                                                    <div className="hidden md:flex mt-1.5 justify-end opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                                        <FormDots history={player.form} />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                )}
                            </div>
                        )}

                        {/* VIEW: Match History */}
                        {activeTab === 'history' && (
                            <div className="space-y-4 animate-fade-in">
                                {matches.length === 0 ? (
                                    <div className="min-card rounded-2xl p-8 text-center text-gray-500">
                                        <p className="text-sm">Ni shranjenih tekem. Dodaj prvo tekmo!</p>
                                    </div>
                                ) : (
                                    matches.map((match) => {
                                        const winners = players.filter(p => match.winnerIds && match.winnerIds.includes(p.id)).map(p => p.name);
                                        const losers = players.filter(p => match.loserIds && match.loserIds.includes(p.id)).map(p => p.name);
                                        const guestWinners = match.guestWinners || [];
                                        const guestLosers = match.guestLosers || [];
                                        const totalWinners = winners.length + guestWinners.length;
                                        const totalLosers = losers.length + guestLosers.length;
                                        
                                        return (
                                    <div key={match.id} className="min-card rounded-2xl overflow-hidden group hover:border-[#3f3f46] transition-all">
                                        {/* Match Header */}
                                        <div className="bg-[#27272a]/50 px-5 py-3 border-b border-[#27272a] flex justify-between items-center">
                                            <span className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">{formatDate(match.date)}</span>
                                            <button
                                                onClick={() => removeMatch(match.id)}
                                                className="p-1.5 hover:bg-red-500/20 rounded-lg text-gray-500 hover:text-red-400 transition-all opacity-0 group-hover:opacity-100"
                                                title="Izbriši tekmo"
                                            >
                                                <Trash className="w-4 h-4" />
                                            </button>
                                        </div>
                                        
                                        <div className="flex flex-col sm:flex-row text-sm">
                                            {/* Winners */}
                                            <div className="flex-1 p-5 border-b sm:border-b-0 sm:border-r border-[#27272a]">
                                                <p className="text-[10px] text-emerald-500 font-bold uppercase tracking-widest mb-3">Zmagovalci</p>
                                                <div className="space-y-1">
                                                            {winners.map(p => (
                                                        <div key={p} className="text-gray-200 font-medium flex items-center gap-2">
                                                            {p}
                                                        </div>
                                                    ))}
                                                            {guestWinners.map((p, i) => (
                                                                <div key={`guest-${i}`} className="text-gray-400 font-medium flex items-center gap-2 text-xs italic">
                                                                    {p} <span className="text-gray-600">(gost)</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            
                                            {/* Losers */}
                                            <div className="flex-1 p-5">
                                                <p className="text-[10px] text-gray-500 font-bold uppercase tracking-widest mb-3">Poraženci</p>
                                                <div className="space-y-1">
                                                            {losers.map(p => (
                                                        <div key={p} className="text-gray-500">{p}</div>
                                                    ))}
                                                            {guestLosers.map((p, i) => (
                                                                <div key={`guest-${i}`} className="text-gray-600 text-xs italic">
                                                                    {p} <span className="text-gray-700">(gost)</span>
                                                </div>
                                                            ))}
                                            </div>
                                        </div>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        )}

                        {/* VIEW: Player Management */}
                        {activeTab === 'players' && (
                            <div className="space-y-4 animate-fade-in">
                                <div className="min-card rounded-2xl p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-lg font-sport font-bold text-white uppercase tracking-wide">Upravljanje Igralcev</h2>
                                        <button
                                            onClick={() => setShowPlayerModal(true)}
                                            className="px-4 py-2 bg-emerald-500 hover:bg-emerald-400 text-black font-sport font-bold rounded-xl transition-all flex items-center gap-2"
                                        >
                                            <Plus className="w-4 h-4" />
                                            Dodaj Igralca
                                        </button>
                                    </div>

                                    {players.length === 0 ? (
                                        <div className="text-center py-8 text-gray-500">
                                            <p className="text-sm mb-4">Ni igralcev. Dodaj prvega igralca!</p>
                                            <button
                                                onClick={() => setShowPlayerModal(true)}
                                                className="px-6 py-2 bg-emerald-500 hover:bg-emerald-400 text-black font-sport font-bold rounded-xl transition-all"
                                            >
                                                Dodaj Prvega Igralca
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {players.map((player, index) => (
                                                <div
                                                    key={player.id}
                                                    className="flex items-center justify-between p-4 bg-[#27272a]/50 rounded-xl hover:bg-[#27272a] transition-colors group"
                                                >
                                                    <div className="flex items-center gap-4">
                                                        <div className="w-10 h-10 rounded-full bg-gray-800 text-gray-400 flex items-center justify-center text-sm font-bold">
                                                            {index + 1}
                                                        </div>
                                                        <div>
                                                            <div className="font-bold text-gray-200">{player.name}</div>
                                                            <div className="text-xs">
                                                                {(() => {
                                                                    const stats = calculatePlayerStats(player.id, matches);
                                                                    const totalMatches = stats.wins + stats.losses;
                                                                    if (totalMatches === 0) {
                                                                        return <span className="text-gray-600">Ni tekem</span>;
                                                                    }
                                                                    return (
                                                                        <>
                                                                            <span className="text-emerald-400 font-semibold">{stats.wins}</span>
                                                                            <span className="text-gray-600"> zmag, </span>
                                                                            <span className="text-red-400 font-semibold">{stats.losses}</span>
                                                                            <span className="text-gray-600"> porazov</span>
                                                                        </>
                                                                    );
                                                                })()}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <button
                                                            onClick={() => {
                                                                setEditingPlayer(player);
                                                                setShowEditPlayerModal(true);
                                                            }}
                                                            className="p-2 hover:bg-blue-500/20 rounded-lg text-gray-500 hover:text-blue-400 transition-all"
                                                            title="Uredi igralca"
                                                        >
                                                            <Edit className="w-5 h-5" />
                                                        </button>
                                                        <button
                                                            onClick={() => removePlayer(player.id)}
                                                            className="p-2 hover:bg-red-500/20 rounded-lg text-gray-500 hover:text-red-400 transition-all"
                                                            title="Izbriši igralca"
                                                        >
                                                            <Trash className="w-5 h-5" />
                                                        </button>
                                        </div>
                                    </div>
                                ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Floating Action Button */}
                    {players.length > 0 && (
                    <button 
                            onClick={() => setShowMatchModal(true)}
                        className="fixed bottom-8 right-6 w-14 h-14 bg-emerald-500 text-black rounded-full flex items-center justify-center shadow-lg hover:bg-emerald-400 transition-all hover:scale-110 active:scale-95 z-40"
                            title="Dodaj Tekmo"
                    >
                        <Plus className="w-6 h-6" strokeWidth={3} />
                    </button>
                    )}

                    <MatchModal 
                        isOpen={showMatchModal} 
                        onClose={() => setShowMatchModal(false)} 
                        players={players}
                        onSaveMatch={addMatch}
                    />
                    
                    <AddPlayerModal 
                        isOpen={showPlayerModal} 
                        onClose={() => setShowPlayerModal(false)} 
                        onAddPlayer={addPlayer}
                    />
                    
                    <EditPlayerModal 
                        isOpen={showEditPlayerModal} 
                        onClose={() => {
                            setShowEditPlayerModal(false);
                            setEditingPlayer(null);
                        }} 
                        player={editingPlayer}
                        onSavePlayer={editPlayer}
                    />
                    
                    <PlayerProfileModal 
                        isOpen={showPlayerProfileModal} 
                        onClose={() => {
                            setShowPlayerProfileModal(false);
                            setSelectedPlayerProfile(null);
                        }} 
                        player={selectedPlayerProfile}
                        matches={matches}
                        allPlayers={players}
                    />
                    
                    <ImportModal 
                        isOpen={showImportModal} 
                        onClose={() => setShowImportModal(false)} 
                        onImportSuccess={handleImportSuccess}
                        onImportError={handleImportError}
                    />

                </div>
            );
        }

        // Initialize React with error handling
        try {
            const rootElement = document.getElementById('root');
            if (!rootElement) {
                console.error('Root element not found!');
                document.body.innerHTML = '<div style="color: white; padding: 20px;">Error: Root element not found</div>';
            } else {
                const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
            }
        } catch (error) {
            console.error('React initialization error:', error);
            document.body.innerHTML = '<div style="color: white; padding: 20px;">Error: ' + error.message + '</div>';
        }
    </script>
</body>
</html>